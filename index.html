<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时播放音乐</title>
</head>
<body>
    <h1>定时播放音乐</h1>

    <label for="playDate">选择播放日期和时间:</label>
    <input type="datetime-local" id="playDate" name="playDate">
    <button onclick="schedulePlay()">开始播放</button>
    <button onclick="playMusic()">立即播放</button>
    <p id="currentTime"></p>
    <p id="remainingTime"></p>

    <script>
        var audio = new Audio('https://music-1324776070.cos.ap-nanjing.myqcloud.com/%E8%94%A1%E7%90%B4%20-%20%E6%B8%A1%E5%8F%A3.flac'); // 更换成您的音乐文件路径
        var context = new AudioContext();
        var source = context.createBufferSource();
        var buffer = null;
        var startTime = 0;

        function playMusic() {
            source.start(0, startTime);
        }

        function getCurrentTime() {
            var now = new Date();
            var hours = now.getHours().toString().padStart(2, '0');
            var minutes = now.getMinutes().toString().padStart(2, '0');
            var seconds = now.getSeconds().toString().padStart(2, '0');
            return hours + ":" + minutes + ":" + seconds;
        }

        function fetchBeijingTime() {
            return fetch('https://worldtimeapi.org/api/timezone/Asia/Shanghai')
                .then(response => response.json())
                .then(data => {
                    return new Date(data.utc_datetime);
                })
                .catch(error => {
                    console.error('Error fetching Beijing time:', error);
                    return null;
                });
        }

        setInterval(function() {
            fetchBeijingTime()
                .then(beijingTime => {
                    if (beijingTime) {
                        document.getElementById('currentTime').textContent = "当前时间：" + beijingTime.toLocaleString();
                    }
                });
        }, 1000); // Update current time every second

        function updateRemainingTime(playDate) {
            fetchBeijingTime()
                .then(beijingTime => {
                    if (beijingTime) {
                        var now = beijingTime;

                        var timeUntilTarget = playDate - now;

                        if (timeUntilTarget <= 0) {
                            document.getElementById('remainingTime').textContent = "请选择一个将来的日期和时间！";
                            return;
                        }

                        var hoursLeft = Math.floor(timeUntilTarget / (1000 * 60 * 60));
                        var minutesLeft = Math.floor((timeUntilTarget % (1000 * 60 * 60)) / (1000 * 60));
                        var secondsLeft = Math.floor((timeUntilTarget % (1000 * 60)) / 1000);

                        document.getElementById('remainingTime').textContent = "剩余播放时间：" + hoursLeft + " 小时 " + minutesLeft + " 分钟 " + secondsLeft + " 秒";
                    }
                });
        }

        function schedulePlay() {
            var playDateInput = document.getElementById('playDate');
            var playDate = new Date(playDateInput.value);

            updateRemainingTime(playDate);

            // Calculate the time until the scheduled play
            var timeUntilPlay = playDate - new Date();

            fetch(audio.src)
                .then(response => response.arrayBuffer())
                .then(data => context.decodeAudioData(data))
                .then(decodedData => {
                    buffer = decodedData;
                    source.buffer = buffer;
                    source.connect(context.destination);
                    startTime = context.currentTime + (timeUntilPlay / 1000); // Adjust start time based on the remaining time
                })
                .catch(error => {
                    console.error('Error loading audio:', error);
                });

            // Update remaining time only once after scheduled time
            setTimeout(function() {
                updateRemainingTime(playDate);
            }, timeUntilPlay); // Update remaining time after scheduled time
        }

        // Real-time playback correction
        setInterval(function() {
            if (source.buffer && source.playbackState === source.PLAYING_STATE) {
                var difference = context.currentTime - startTime;
                startTime += difference * 0.01; // Adjust the start time to correct the playback
            }
        }, 100); // Check and correct every 100 milliseconds
    </script>
</body>
</html>
