<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时播放音乐</title>
</head>
<body>
    <h1>定时播放音乐</h1>

    <label for="playDate">选择播放日期和时间:</label>
    <input type="datetime-local" id="playDate" name="playDate">
    <button onclick="schedulePlay()">开始播放</button>
    <button onclick="playMusic()">立即播放</button>
    <p id="currentTime"></p>
    <p id="remainingTime"></p>

    <script>
        var audio = new Audio('https://freetyst.nf.migu.cn/public/product9th/product46/2023/08/0618/2023%E5%B9%B403%E6%9C%8816%E6%97%A515%E7%82%B947%E5%88%86%E5%86%85%E5%AE%B9%E5%87%86%E5%85%A5%E6%96%B0%E8%88%AA%E9%81%935011%E9%A6%96715301/%E6%A0%87%E6%B8%85%E9%AB%98%E6%B8%85/MP3_320_16_Stero/6903170AX6U182104.mp3?Key=d27f4d2ca5a3c235&Tim=1709656635376&channelid=00&msisdn=6064ae8418b94f3c8d59eb5a0c8d3461&CI=6903170AX6U2600919000009223585&F=020010'); // 更换成您的音乐文件路径

        function playMusic() {
            audio.play();
        }

        function getCurrentTime() {
            var now = new Date();
            var hours = now.getHours().toString().padStart(2, '0');
            var minutes = now.getMinutes().toString().padStart(2, '0');
            var seconds = now.getSeconds().toString().padStart(2, '0');
            return hours + ":" + minutes + ":" + seconds;
        }

        function fetchBeijingTime() {
            return fetch('https://worldtimeapi.org/api/timezone/Asia/Shanghai')
                .then(response => response.json())
                .then(data => {
                    return new Date(data.utc_datetime);
                })
                .catch(error => {
                    console.error('Error fetching Beijing time:', error);
                    return null;
                });
        }

        setInterval(function() {
            fetchBeijingTime()
                .then(beijingTime => {
                    if (beijingTime) {
                        document.getElementById('currentTime').textContent = "当前时间：" + beijingTime.toLocaleString();
                    }
                });
        }, 1000); // Update current time every second

        function updateRemainingTime(playDate) {
            fetchBeijingTime()
                .then(beijingTime => {
                    if (beijingTime) {
                        var now = beijingTime;

                        var timeUntilTarget = playDate - now;

                        if (timeUntilTarget <= 0) {
                            document.getElementById('remainingTime').textContent = "请选择一个将来的日期和时间！";
                            return;
                        }

                        var hoursLeft = Math.floor(timeUntilTarget / (1000 * 60 * 60));
                        var minutesLeft = Math.floor((timeUntilTarget % (1000 * 60 * 60)) / (1000 * 60));
                        var secondsLeft = Math.floor((timeUntilTarget % (1000 * 60)) / 1000);

                        document.getElementById('remainingTime').textContent = "剩余播放时间：" + hoursLeft + " 小时 " + minutesLeft + " 分钟 " + secondsLeft + " 秒";
                    }
                });
        }

        function schedulePlay() {
            var playDateInput = document.getElementById('playDate');
            var playDate = new Date(playDateInput.value);

            updateRemainingTime(playDate);

            // Calculate the time until the scheduled play
            var timeUntilPlay = playDate - new Date();

            // Synchronize with WebRTC to play the audio precisely at the scheduled time
            var rtcPeerConnection = new RTCPeerConnection();

            rtcPeerConnection.onicecandidate = function(event) {
                if (event.candidate) return;
                var currentTime = new Date();
                var timeToStart = playDate - currentTime;
                setTimeout(playMusic, timeToStart);
            };

            rtcPeerConnection.createDataChannel('');

            rtcPeerConnection.createOffer()
                .then(offer => rtcPeerConnection.setLocalDescription(offer))
                .catch(console.error);

            setInterval(function() {
                updateRemainingTime(playDate);
            }, 1000); // Update remaining time every second
        }
    </script>
</body>
</html>
